/**

	----------------- ISWITCH MINDFUCK ( HOW MUCH CODE IS NEEDED TO MAKE ONE FUCKING BUTTON WORKING ) -----------------


	1. Script runs FIRST time on Zbrush startup, memory blocks are created in this time


	2. Script runs EVERY time any control is fired, if scripth has been interrupted by another plugin
		( If another plugin or script is used then first fire of control RUNS WHOLE SCRIPT AGAIN )


	3. First click on iSwitch FIRES EVENT OF INIT STATE, NOT OPPOSITE STATE as should be excepted
  		( if PRESSED, then FIRES PRESSED, if UNPRESSED, then fires UNPRESSED )

		BUT THIS HAPPEN ONLY IF ISWITCH IS IN INIT STATE
			( if INIT STATE is PRESSED and iSwitch is UNPRESSED, then works normaly  )


*/

/* INIT STATE OF SWITCH */
[VarSet, $INIT_STATE, 0 ]
//[VarSet, $INIT_STATE, 1 ]

[VarDef, $CONFIGFILE,	[FileNameResolvePath, "TemplateData\iSwitch\switchConfig.zvr"] ]

[VarDef, $plugin_initialized, [MemGetSize, INIT_STATE ] > 0 ] // this avoid run code on startp of zbrush


[VarDef, $DATA_LIST(1), 0]

[VarDef, $VALUE_LOADED]


/** dataFileSave
  *
  */
[RoutineDef, dataFileSave
,
	//[Note, $PLUGIN_DATA_PATH ]
	[VarSet, $DATA_LIST([Var, $index]), $value_to_save ]

	[VarSave, $DATA_LIST, $CONFIGFILE ]

	//[Note, [StrMerge, "dataFile.configSave \n\nIndex: ", $index, "\n\nValue: ",  $value_to_save ],, 0]

, // PARAMS
	$index, $value_to_save
]
//[IButton, "dataFileSave()" , "", [RoutineCall, dataFileSave, 0, "Test value"] ]


/** dataFileLoad
  *
  */
[RoutineDef, dataFileLoad
,
	[VarLoad, $DATA_LIST, $CONFIGFILE ]

	[VarSet, $VALUE_LOADED, [Var, $DATA_LIST([Var, $index]) ] ]

	[Note, $VALUE_LOADED ]

, // PARAMS
	$index
]
//[IButton, "dataFileLoad()" , "", [RoutineCall, dataFileLoad, 0 ] ]




/** saveConfig
//  */
//[RoutineDef, saveConfig
//,
//	//[Note, "saveConfig"]
//	[Var, $error, [MemSaveToFile, CURRENT_STATE, $CONFIGFILE, 1]]
//
//	[Note, [StrMerge, "error,: ", [Var, $error ] ]
//
//]
//[IButton, "saveConfig()" , "", [RoutineCall, saveConfig] ]


[If, ! [MemGetSize, INIT_STATE ]
,
	/* DEFINE MEMORY BLOCKS */
	[MVarDef, INIT_STATE,	1 ]
	[MVarDef, CURRENT_STATE,	1 ]

	/* SET DEFAULTS */
	[MVarSet, INIT_STATE,	0, [Var, $INIT_STATE] ]
	[MVarSet, CURRENT_STATE,	0, [Var, $INIT_STATE] ]

	[If, ! [FileExists, $CONFIGFILE]
	, // THEN

		[RoutineCall, dataFileSave, 0, [Var, $INIT_STATE] ]
	]

	[RoutineCall, dataFileLoad, 0 ]

	[MVarSet, INIT_STATE,	0, [Var, $VALUE_LOADED] ]
	[MVarSet, CURRENT_STATE,	0, [Var, $VALUE_LOADED] ]

]



/*  UI */
[VarSet, $PLUGIN_NENU, "~CONFIG_TEST"]

[IPalette, $PLUGIN_NENU ]

[VarSet, $switch_button, [StrMerge, $PLUGIN_NENU, ":", "Switch"] ]
[VarSet, $init_button, [StrMerge, $PLUGIN_NENU, ":", "Init"] ]


//[IButton, $init_button, "Tooltip"
//,
//	//Commands
//	[RoutineCall, dataFileLoad, 0 ]
//
//,	/*Disabled*/,	/*Width*/,	/*Hotkey*/,	/*Icon*/,	/*Height*/]

/* ----- SWITCH  BUTTON----- */
[ISwitch, $switch_button, [MVarGet, INIT_STATE, 0], ""
, // PRESS

	[Note, "Enable",, 0.5]

	[MVarSet, CURRENT_STATE, 0, 1 ]
	//[RoutineCall, saveConfig]
	//[MemSaveToFile, CURRENT_STATE, $CONFIGFILE, 1]

	[RoutineCall, dataFileSave, 0, 1 ]

, // UNPRESS

	[Note, "Disable",, 0.5]

	[MVarSet, CURRENT_STATE, 0, 0 ]

	//[RoutineCall, saveConfig]

	//[MemSaveToFile, CURRENT_STATE, $CONFIGFILE, 1]
	[RoutineCall, dataFileSave, 0, 0 ]

,,,	48]


/* FORCE SWITCH TO CORRECT STATE ON FIRST HIT, BUT NOT ON ZBRUSH STARTUP */
[If, [Var, $plugin_initialized] && ([MVarGet, CURRENT_STATE, 0 ] == [MVarGet, INIT_STATE, 0 ])
, // THEN
	[ISet,  $switch_button, ! [MVarGet, CURRENT_STATE, 0 ]  ]
]







